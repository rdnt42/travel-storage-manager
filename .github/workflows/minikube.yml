name: CI
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    branches: [ master ]
jobs:
  build:
    runs-on: [ server-marowak ]
    name: build jar

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v4.2
        with:
          maven-version: 3.8.2
      - name: Build with Maven
        run: mvn -B package '-Pprod' '-Dmaven.test.skip=true' --file pom.xml

  deploy:
    runs-on: [ server-marowak ]
    name: build image and deploy to minikube

    needs: [build]

    steps:
      - name: Try the cluster !
        run: kubectl get pods -A
      - name: Build image
        run: |
          docker build -t travel-storage-manager .
          echo -n "verifying images:"
          docker images
      - name: Deploy to minikube
        run: |
          kubectl apply -f deployment-db.yaml
          kubectl apply -f deployment-backend.yaml
      - name: Get service
        run: kubectl get service travel-storage-manager-service
